# AgentIndex Nginx Configuration
# Reverse proxy with rate limiting and security headers

# Rate limiting zone
limit_req_zone $binary_remote_addr zone=api:10m rate=2r/s;

server {
    listen 8443 ssl;
    server_name _;

    # SSL (self-signed for now, replace with Let's Encrypt for production)
    # Generate with: openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    #   -keyout /opt/homebrew/etc/nginx/ssl/agentindex.key \
    #   -out /opt/homebrew/etc/nginx/ssl/agentindex.crt
    ssl_certificate /opt/homebrew/etc/nginx/ssl/agentindex.crt;
    ssl_certificate_key /opt/homebrew/etc/nginx/ssl/agentindex.key;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";

    # No server info leak
    server_tokens off;

    # Block common scraping patterns
    if ($http_user_agent ~* (scrapy|wget|curl|python-requests)) {
        # Don't block — agents use these. But log for monitoring.
        access_log /opt/homebrew/var/log/nginx/suspicious.log;
    }

    # Discovery API
    location /v1/ {
        limit_req zone=api burst=10 nodelay;

        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # No caching — results should always be fresh
        add_header Cache-Control "no-store, no-cache";
    }

    # Block everything else
    location / {
        return 404 '{"error": "not_found"}';
        add_header Content-Type application/json;
    }

    # Block attempts to access admin/debug endpoints
    location ~ ^/(admin|debug|status|metrics|graphql) {
        return 403 '{"error": "forbidden"}';
        add_header Content-Type application/json;
    }
}
